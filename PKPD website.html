<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Bloom - Game Scores</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            font-size: 1.2em;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #FFD700;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .chart-container {
            height: 300px;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .score-badge {
            display: inline-block;
            padding: 5px 15px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            border-radius: 20px;
            font-weight: bold;
        }

        .status-online {
            color: #4CAF50;
        }

        .status-offline {
            color: #FF5252;
        }

        .device-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .device-chip {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .device-chip:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .device-chip.active {
            background: #4CAF50;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ® Memory Bloom</h1>
            <p class="subtitle">å¯¦æ™‚éŠæˆ²åˆ†æ•¸ç›£æ§ç³»çµ±</p>
        </header>

        <div class="dashboard">
            <!-- å¯¦æ™‚çµ±è¨ˆ -->
            <div class="card">
                <h2><i>ğŸ“Š</i> éŠæˆ²çµ±è¨ˆ</h2>
                <div class="stat-number" id="totalGames">0</div>
                <div class="stat-label">ç¸½éŠæˆ²æ¬¡æ•¸</div>
                <div class="stat-number" id="averageScore">0</div>
                <div class="stat-label">å¹³å‡åˆ†æ•¸</div>
                <div class="stat-number" id="highScore">0</div>
                <div class="stat-label">æœ€é«˜åˆ†æ•¸</div>
            </div>

            <!-- å¯¦æ™‚åœ–è¡¨ -->
            <div class="card">
                <h2><i>ğŸ“ˆ</i> åˆ†æ•¸è¶¨å‹¢</h2>
                <div class="chart-container">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>

            <!-- æœ€æ–°åˆ†æ•¸ -->
            <div class="card">
                <h2><i>ğŸ¯</i> æœ€æ–°æˆç¸¾</h2>
                <div class="stat-number" id="latestScore">0</div>
                <div class="stat-label">æœ€æ–°åˆ†æ•¸</div>
                <div id="latestTime">--:--:--</div>
                <div class="stat-label">æ›´æ–°æ™‚é–“</div>
                <div id="connectionStatus" class="status-offline">é›¢ç·š</div>
            </div>
        </div>

        <!-- è¨­å‚™é¸æ“‡ -->
        <div class="card">
            <h2><i>ğŸ“±</i> è¨­å‚™åˆ—è¡¨</h2>
            <div class="device-list" id="deviceList">
                <div class="loading">è¼‰å…¥è¨­å‚™ä¸­...</div>
            </div>
        </div>

        <!-- è©³ç´°è¨˜éŒ„ -->
        <div class="card">
            <h2><i>ğŸ“‹</i> éŠæˆ²è¨˜éŒ„</h2>
            <div id="recordsTable">
                <table>
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>åˆ†æ•¸</th>
                            <th>åºåˆ—é•·åº¦</th>
                            <th>éŠæˆ²æ™‚é•·</th>
                            <th>è¨­å‚™</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr>
                            <td colspan="5" class="loading">è¼‰å…¥è¨˜éŒ„ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        <p>Memory Bloom - è¨˜æ†¶åŠ›è¨“ç·´éŠæˆ² | æ•¸æ“šå¯¦æ™‚åŒæ­¥è‡³Firebase</p>
        <p>æœ€å¾Œæ›´æ–°: <span id="lastUpdate">--:--:--</span></p>
    </footer>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // å…¨å±€è®Šé‡
        let currentDevice = null;
        let scoreChart = null;
        let scores = [];
        let devices = [];

        // åˆå§‹åŒ–åœ–è¡¨
        function initChart() {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'åˆ†æ•¸è¶¨å‹¢',
                        data: [],
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#fff' }
                        }
                    }
                }
            });
        }

        // åŠ è¼‰è¨­å‚™åˆ—è¡¨
        async function loadDevices() {
            try {
                const snapshot = await database.ref('devices').once('value');
                const devicesData = snapshot.val();
                
                if (!devicesData) {
                    document.getElementById('deviceList').innerHTML = '<div class="loading">æš«ç„¡è¨­å‚™æ•¸æ“š</div>';
                    return;
                }
                
                devices = Object.keys(devicesData);
                const deviceList = document.getElementById('deviceList');
                deviceList.innerHTML = '';
                
                devices.forEach(deviceId => {
                    const chip = document.createElement('div');
                    chip.className = 'device-chip';
                    chip.innerHTML = `<i>ğŸ“±</i> ${deviceId.substring(0, 8)}...`;
                    chip.onclick = () => selectDevice(deviceId);
                    deviceList.appendChild(chip);
                });
                
                // é»˜èªé¸æ“‡ç¬¬ä¸€å€‹è¨­å‚™
                if (devices.length > 0) {
                    selectDevice(devices[0]);
                }
                
            } catch (error) {
                console.error('åŠ è¼‰è¨­å‚™å¤±æ•—:', error);
            }
        }

        // é¸æ“‡è¨­å‚™
        function selectDevice(deviceId) {
            currentDevice = deviceId;
            
            // æ›´æ–°UI
            document.querySelectorAll('.device-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.textContent.includes(deviceId.substring(0, 8))) {
                    chip.classList.add('active');
                }
            });
            
            // åŠ è¼‰è¨­å‚™æ•¸æ“š
            loadDeviceData(deviceId);
            
            // ç›£è½å¯¦æ™‚æ›´æ–°
            listenForRealtimeUpdates(deviceId);
        }

        // åŠ è¼‰è¨­å‚™æ•¸æ“š
        async function loadDeviceData(deviceId) {
            try {
                // åŠ è¼‰çµ±è¨ˆæ•¸æ“š
                const statsSnapshot = await database.ref(`devices/${deviceId}/statistics`).once('value');
                const stats = statsSnapshot.val();
                
                if (stats) {
                    document.getElementById('totalGames').textContent = stats.totalGames || 0;
                    document.getElementById('averageScore').textContent = stats.averageScore ? stats.averageScore.toFixed(1) : 0;
                    document.getElementById('highScore').textContent = stats.highScore || 0;
                }
                
                // åŠ è¼‰æ­·å²è¨˜éŒ„
                const scoresSnapshot = await database.ref(`devices/${deviceId}/scores`).once('value');
                const scoresData = scoresSnapshot.val();
                
                if (scoresData) {
                    scores = Object.values(scoresData).sort((a, b) => b.timestamp - a.timestamp);
                    updateRecordsTable();
                    updateChart();
                    
                    // é¡¯ç¤ºæœ€æ–°åˆ†æ•¸
                    if (scores.length > 0) {
                        const latest = scores[0];
                        document.getElementById('latestScore').textContent = latest.score;
                        document.getElementById('latestTime').textContent = new Date(latest.timestamp * 1000).toLocaleTimeString();
                    }
                }
                
                // æ›´æ–°ç‹€æ…‹
                document.getElementById('connectionStatus').textContent = 'åœ¨ç·š';
                document.getElementById('connectionStatus').className = 'status-online';
                
            } catch (error) {
                console.error('åŠ è¼‰æ•¸æ“šå¤±æ•—:', error);
            }
        }

        // ç›£è½å¯¦æ™‚æ›´æ–°
        function listenForRealtimeUpdates(deviceId) {
            // ç›£è½æ–°åˆ†æ•¸
            database.ref(`devices/${deviceId}/scores`).on('child_added', (snapshot) => {
                const newScore = snapshot.val();
                newScore.id = snapshot.key;
                
                scores.unshift(newScore);
                if (scores.length > 20) scores.pop();
                
                updateRecordsTable();
                updateChart();
                updateLatestScore(newScore);
                
                // æ’­æ”¾é€šçŸ¥éŸ³æ•ˆ
                playNotificationSound();
                
                // é¡¯ç¤ºé€šçŸ¥
                showNotification(`æ–°åˆ†æ•¸: ${newScore.score}`);
            });
            
            // ç›£è½çµ±è¨ˆæ›´æ–°
            database.ref(`devices/${deviceId}/statistics`).on('value', (snapshot) => {
                const stats = snapshot.val();
                if (stats) {
                    document.getElementById('totalGames').textContent = stats.totalGames || 0;
                    document.getElementById('averageScore').textContent = stats.averageScore ? stats.averageScore.toFixed(1) : 0;
                    document.getElementById('highScore').textContent = stats.highScore || 0;
                }
            });
        }

        // æ›´æ–°è¨˜éŒ„è¡¨æ ¼
        function updateRecordsTable() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            scores.slice(0, 10).forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(record.timestamp * 1000).toLocaleString()}</td>
                    <td><span class="score-badge">${record.score}</span></td>
                    <td>${record.sequenceLength || 'N/A'}</td>
                    <td>${record.duration ? record.duration + 's' : 'N/A'}</td>
                    <td>${record.deviceID ? record.deviceID.substring(0, 8) + '...' : 'Unknown'}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // æ›´æ–°åœ–è¡¨
        function updateChart() {
            const chartScores = scores.slice(0, 10).reverse();
            
            scoreChart.data.labels = chartScores.map((_, index) => `ç¬¬${index + 1}æ¬¡`);
            scoreChart.data.datasets[0].data = chartScores.map(score => score.score);
            scoreChart.update();
        }

        // æ›´æ–°æœ€æ–°åˆ†æ•¸
        function updateLatestScore(score) {
            document.getElementById('latestScore').textContent = score.score;
            document.getElementById('latestScore').classList.add('pulse');
            
            document.getElementById('latestTime').textContent = new Date().toLocaleTimeString();
            
            setTimeout(() => {